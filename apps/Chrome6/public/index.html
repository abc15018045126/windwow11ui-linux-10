<!DOCTYPE html>
<html>
<head>
  <title>Chrome 6</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #202124;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .controls {
      display: flex;
      align-items: center;
      padding: 8px;
      background-color: #35363a;
      flex-shrink: 0;
    }
    .nav-buttons button {
      background: none;
      border: none;
      color: white;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      margin: 0 4px;
    }
    .nav-buttons button:hover {
      background-color: #444548;
    }
    .nav-buttons button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .address-bar {
      flex-grow: 1;
      margin: 0 8px;
    }
    .address-bar input {
      width: 100%;
      background-color: #202124;
      border: 1px solid #5f6368;
      border-radius: 20px;
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      outline: none;
    }
    .address-bar input:focus {
      border-color: #8ab4f8;
    }
    .stream-container {
      flex-grow: 1;
      position: relative;
    }
    #stream {
      width: 100%;
      height: 100%;
      object-fit: contain;
      cursor: crosshair;
    }
  </style>
</head>
<body>

  <div class="controls">
    <div class="nav-buttons">
      <button id="back-btn" title="Back">&larr;</button>
      <button id="fwd-btn" title="Forward">&rarr;</button>
      <button id="reload-btn" title="Reload">&#x21bb;</button>
    </div>
    <div class="address-bar">
      <input type="text" id="url-input" placeholder="Enter a URL">
    </div>
  </div>

  <div class="stream-container">
    <img id="stream" alt="Browser stream">
  </div>

  <script>
    const backBtn = document.getElementById('back-btn');
    const fwdBtn = document.getElementById('fwd-btn');
    const reloadBtn = document.getElementById('reload-btn');
    const urlInput = document.getElementById('url-input');
    const streamImg = document.getElementById('stream');

    const inputSocket = new WebSocket('ws://localhost:8083');
    const frameSocket = new WebSocket('ws://localhost:8084');

    inputSocket.onopen = () => console.log('Input WebSocket connected');
    inputSocket.onerror = (err) => console.error('Input WebSocket error:', err);

    frameSocket.onopen = () => console.log('Frame WebSocket connected');
    frameSocket.binaryType = 'blob';
    frameSocket.onerror = (err) => console.error('Frame WebSocket error:', err);

    frameSocket.onmessage = (event) => {
      const imageUrl = URL.createObjectURL(event.data);
      streamImg.src = imageUrl;
      streamImg.onload = () => URL.revokeObjectURL(imageUrl);
    };

    function sendCommand(type, payload) {
      if (inputSocket.readyState === WebSocket.OPEN) {
        inputSocket.send(JSON.stringify({ type, ...payload }));
      }
    }

    backBtn.onclick = () => sendCommand('action', { command: 'goBack' });
    fwdBtn.onclick = () => sendCommand('action', { command: 'goForward' });
    reloadBtn.onclick = () => sendCommand('action', { command: 'reload' });

    urlInput.onkeydown = (e) => {
      if (e.key === 'Enter') {
        let url = urlInput.value.trim();
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }
        sendCommand('navigate', { url });
      }
    };

    // --- Input Event Forwarding ---
    function sendInputEvent(type, payload) {
      // Electron's sendInputEvent uses a specific format.
      // We'll construct a simplified version here.
      const eventPayload = { type: type, ...payload };
      sendCommand('input', { payload: eventPayload });
    }

    streamImg.addEventListener('mousedown', (e) => {
      sendInputEvent('mouseDown', { x: e.offsetX, y: e.offsetY, button: e.button === 1 ? 'middle' : e.button === 2 ? 'right' : 'left', clickCount: 1 });
    });

    streamImg.addEventListener('mouseup', (e) => {
      sendInputEvent('mouseUp', { x: e.offsetX, y: e.offsetY, button: e.button === 1 ? 'middle' : e.button === 2 ? 'right' : 'left', clickCount: 1 });
    });

    streamImg.addEventListener('mousemove', (e) => {
      // To avoid flooding the socket, you might want to throttle this
      sendInputEvent('mouseMove', { x: e.offsetX, y: e.offsetY });
    });

    // Prevent the context menu on the image itself
    streamImg.addEventListener('contextmenu', (e) => e.preventDefault());

    document.addEventListener('keydown', (e) => {
      // This will capture all key presses, which might not be ideal.
      // A more robust solution would focus on when the stream is active.
      sendInputEvent('keyDown', { keyCode: e.key, code: e.code, modifiers: [] }); // Modifiers would need more logic
    });

    document.addEventListener('keyup', (e) => {
      sendInputEvent('keyUp', { keyCode: e.key, code: e.code, modifiers: [] });
    });

  </script>
</body>
</html>
